<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drum Notation Editor ‚Äî Drumz.ru</title>
  <style>
    body {
      background: #1a1a2e;
      color: white;
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      background: #4e54c8;
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 0 5px 6px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #3a3fb8; }
    button:disabled { opacity: 0.6; }

    .grid {
      display: grid;
      grid-template-columns: 90px repeat(16, 1fr);
      gap: 2px;
    }
    .label {
      background: #2d2d44;
      padding: 10px 8px;
      text-align: right;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px 0 0 4px;
    }
    .cell {
      background: #2d2d44;
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      user-select: none;
    }
    .cell.active {
      background: #4e54c8;
      color: white;
    }
    .cell:hover {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 70px repeat(16, 1fr);
      }
      .label {
        padding: 8px 4px;
        font-size: 12px;
      }
      .cell {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–æ—Ç–∞—Ü–∏–π –¥–ª—è –±–∞—Ä–∞–±–∞–Ω–æ–≤</h1>
    <div class="controls">
      <button id="playBtn">‚ñ∂Ô∏è Play</button>
      <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      <button id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div class="grid" id="grid"></div>
  </div>

  <script>
    const instruments = [
      { name: 'Kick',    symbol: '‚óè', file: 'kick.wav'    },
      { name: 'Snare',   symbol: 'x', file: 'snare.wav'   },
      { name: 'Hi-Hat',  symbol: 'o', file: 'hihat.wav'   },
      { name: 'Crash',   symbol: '‚òÖ', file: 'splash.wav'  }
    ];
    const steps = 16;
    let grid = Array(instruments.length).fill().map(() => Array(steps).fill(false));
    let isPlaying = false;
    let currentStep = 0;
    let intervalId = null;
    const bpm = 120;
    const stepDuration = (60 / bpm) * 0.25 * 1000; // 16 –¥–æ–ª–µ–π

    let audioContext = null;
    const audioBuffers = {};

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤ ===
    async function loadAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      for (const inst of instruments) {
        try {
          const response = await fetch(inst.file);
          if (!response.ok) throw new Error(`–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${inst.file}`);
          const arrayBuffer = await response.arrayBuffer();
          audioBuffers[inst.name] = await audioContext.decodeAudioData(arrayBuffer);
        } catch (e) {
          console.warn(e.message);
        }
      }
    }

    // === –†–µ–Ω–¥–µ—Ä —Å–µ—Ç–∫–∏ ===
    function renderGrid() {
      const gridEl = document.getElementById('grid');
      gridEl.innerHTML = '';

      instruments.forEach((inst, i) => {
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = inst.name;
        gridEl.appendChild(label);

        for (let j = 0; j < steps; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if (grid[i][j]) {
            cell.classList.add('active');
            cell.textContent = inst.symbol;
          }
          cell.addEventListener('click', () => {
            grid[i][j] = !grid[i][j];
            renderGrid();
          });
          gridEl.appendChild(cell);
        }
      });
    }

    // === –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ===
    function playStep() {
      // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞
      if (currentStep > 0) {
        const prevCol = (currentStep - 1 + steps) % steps;
        document.querySelectorAll(`[data-col="${prevCol}"]`).forEach(cell => {
          cell.style.background = '';
          const row = parseInt(cell.dataset.row);
          if (grid[row][prevCol]) {
            cell.textContent = instruments[row].symbol;
          }
        });
      }

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
      document.querySelectorAll(`[data-col="${currentStep}"]`).forEach(cell => {
        cell.style.background = '#ff6b6b';
      });

      // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –∑–≤—É–∫–æ–≤
      if (audioContext.state === 'suspended') audioContext.resume();
      instruments.forEach((inst, i) => {
        if (grid[i][currentStep] && audioBuffers[inst.name]) {
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffers[inst.name];
          source.connect(audioContext.destination);
          source.start();
        }
      });

      currentStep = (currentStep + 1) % steps;
    }

    async function startPlayback() {
      await loadAudio();
      isPlaying = true;
      currentStep = 0;
      document.getElementById('playBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      intervalId = setInterval(playStep, stepDuration);
    }

    function stopPlayback() {
      isPlaying = false;
      clearInterval(intervalId);
      currentStep = 0;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      renderGrid(); // —Å–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    }

    function clearAll() {
      grid = Array(instruments.length).fill().map(() => Array(steps).fill(false));
      renderGrid();
    }

    // === –°–æ–±—ã—Ç–∏—è ===
    document.getElementById('playBtn').addEventListener('click', startPlayback);
    document.getElementById('stopBtn').addEventListener('click', stopPlayback);
    document.getElementById('clearBtn').addEventListener('click', clearAll);

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    renderGrid();
  </script>
</body>
</html>