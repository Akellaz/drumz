<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drum Book | –ö–Ω–∏–≥–∞ –±–∞—Ä–∞–±–∞–Ω—â–∏–∫–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.7.0/build/opensheetmusicdisplay.min.js"></script>
  
  <style>
    :root {
      --bg: #ffffff;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
      --primary: #4299e1;
      --primary-light: #ebf8ff;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #e53e3e;
      --card-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.05);
      --radius: 12px;
      --spacing: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8fafc;
      color: var(--text);
      margin: 0;
      padding: var(--spacing);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 2.2em;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .header p {
      font-size: 1.1em;
      color: var(--text-light);
      margin-top: 8px;
    }

    .osmd-container {
      width: 100%;
      height: 300px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin: 24px 0;
      overflow: hidden;
    }

    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
      margin: 24px 0;
    }

    .lesson-btn {
      padding: 16px;
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 80px;
    }

    .lesson-btn:hover:not(.locked) {
      border-color: var(--primary);
      background-color: var(--primary-light);
      transform: translateY(-2px);
    }

    .lesson-btn.active {
      border-color: var(--primary);
      background-color: var(--primary-light);
      box-shadow: inset 0 0 0 2px var(--primary);
    }

    .lesson-btn.completed {
      border-color: var(--success);
      background-color: #f0fdf4;
    }

    .lesson-btn.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .lesson-number {
      display: inline-block;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 0.8em;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
    }

    .content-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin: 24px 0;
    }

    @media (max-width: 900px) {
      .content-section {
        grid-template-columns: 1fr;
      }
    }

    .lesson-content,
    .tools-panel {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .lesson-content h2,
    .tools-panel h3 {
      margin-top: 0;
      color: var(--primary);
    }

    .tip, .warning, .info-box {
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      border-left: 4px solid;
    }

    .tip {
      background: #ebf8ff;
      border-left-color: var(--primary);
    }

    .warning {
      background: #fff8e6;
      border-left-color: var(--warning);
    }

    .info-box {
      background: #f0f9ff;
      border-left-color: #3182ce;
    }

    .metronome-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin: 16px 0;
    }

    .interactive-btn,
    .metronome-btn,
    .mode-btn,
    .quiz-btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      text-align: center;
    }

    .interactive-btn:hover,
    .metronome-btn:hover,
    .mode-btn:hover,
    .quiz-btn:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .interactive-btn.correct { background: #f0fdf4; border-color: var(--success); }
    .interactive-btn.wrong { background: #fff5f5; border-color: var(--danger); }

    .play-btn { 
      border-color: var(--success); 
      color: var(--success);
      padding: 12px 24px;
      font-size: 1.1em;
    }
    .stop-btn { 
      border-color: var(--danger); 
      color: var(--danger);
      padding: 12px 24px;
      font-size: 1.1em;
    }

    input[type="range"] {
      width: 160px;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .rhythm-pattern {
      font-size: 2em;
      text-align: center;
      padding: 16px;
      background: #f8fafc;
      border-radius: var(--radius);
      margin: 16px 0;
      font-family: monospace;
    }

    .exercise-section,
    .quiz-section {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      margin: 24px 0;
      border: 1px solid var(--border);
    }

    .quiz-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
    }

    .quiz-btn.selected {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .quiz-btn.correct {
      background: #f0fdf4;
      border-color: var(--success);
      color: var(--success);
    }

    .quiz-btn.wrong {
      background: #fff5f5;
      border-color: var(--danger);
      color: var(--danger);
    }

    .feedback {
      min-height: 24px;
      margin: 12px 0;
      font-weight: 600;
    }

    .tempo-label {
      font-weight: bold;
      color: var(--text);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä—Ç–∏—Ç—É—Ä */
    .scores-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
    }
    
    .score-item {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 15px;
      background: white;
    }
    
    .score-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary);
      font-size: 1.1em;
    }
    
    .score-description {
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f8fafc;
      border-radius: 8px;
      font-size: 0.95em;
      color: var(--text-light);
    }
    
    .score-container {
      height: auto !important;
      min-height: 200px;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: auto;
      text-align: center;
      padding: 10px;
    }
    
    .score-container svg {
      display: inline-block;
      margin: 0 auto;
      width: 100% !important;
      height: auto !important;
      min-height: 200px;
    }
    
    .score-error {
      padding: 20px;
      text-align: center;
      color: var(--danger);
      font-style: italic;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞ */
    .sequencer {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f4f8;
      border-radius: 8px;
      border: 1px solid #d1dce5;
    }
    
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞ */
    .sequencer.highlighted {
      border: 0px solid transparent;
      border-image: linear-gradient(45deg, #48bb78, #38a169, #2f855a) 1;
      box-shadow: 0 0 15px rgba(72, 187, 120, 0.4);
      animation: glow 2s ease-in-out infinite alternate;
      border-radius: 8px;
    }
    
    @keyframes glow {
      from {
        box-shadow: 0 0 10px rgba(72, 187, 120, 0.3);
      }
      to {
        box-shadow: 0 0 20px rgba(72, 187, 120, 0.6), 0 0 30px rgba(72, 187, 120, 0.3);
      }
    }
    
    .sequencer-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--primary);
      text-align: center;
    }
    
    .drum-grid {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 15px;
    }

    .track-row {
      display: flex;
      border-bottom: 1px solid #eee;
    }

    .track-row:last-child {
      border-bottom: none;
    }

    .track-name {
      width: 100px;
      padding: 12px;
      font-weight: bold;
      background: #f8f9fa;
      text-align: right;
      border-right: 1px solid #eee;
      font-size: 14px;
    }

    .track-steps {
      display: flex;
      flex: 1;
      padding: 5px;
    }

    .step {
      width: 30px;
      height: 30px;
      border: 2px solid #ddd;
      margin: 2px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      border-radius: 4px;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    /* –¶–≤–µ—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ 4 —è—á–µ–π–∫–∏ */
    .step.group-0 {
      background-color: #fff3cd;
      border-color: #ffeaa7;
    }

    .step.group-0.active {
      background-color: #ffc107;
      border-color: #e0a800;
    }

    .step.group-1 {
      background-color: #d1ecf1;
      border-color: #b8daff;
    }

    .step.group-1.active {
      background-color: #17a2b8;
      border-color: #138496;
    }

    .step.group-2 {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .step.group-2.active {
      background-color: #dc3545;
      border-color: #bd2130;
    }

    .step.group-3 {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .step.group-3.active {
      background-color: #28a745;
      border-color: #1e7e34;
    }

    .step:hover {
      background-color: #e9ecef;
      border-color: #adb5bd;
    }

    .step.active {
      background-color: #007bff;
      border-color: #0056b3;
      color: white;
      font-weight: bold;
    }

    .step.playing {
      background-color: #ff6b6b !important;
      border-color: #ff5252 !important;
      transform: scale(1.1);
    }

    .sequencer-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .sequencer-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .sequencer-btn:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    
    .sequencer-btn.play {
      border-color: var(--success);
      color: var(--success);
    }
    
    .sequencer-btn.stop {
      border-color: var(--danger);
      color: var(--danger);
    }
    
    .sequencer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .tempo-label {
      font-weight: bold;
      font-size: 14px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .track-name {
        width: 70px;
        padding: 8px;
        font-size: 12px;
      }
      
      .step {
        width: 25px;
        height: 25px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéµ Drum Book</h1>
      <p>–ö–Ω–∏–≥–∞ –±–∞—Ä–∞–±–∞–Ω—â–∏–∫–∞</p>
    </div>

    <div class="lesson-grid">
      <button class="lesson-btn" onclick="loadLesson(1)"><span class="lesson-number"></span> Paradise city</button>
      <button class="lesson-btn" onclick="loadLesson(2)"><span class="lesson-number"></span> Seven Nation Army</button>
      <button class="lesson-btn" onclick="loadLesson(3)"><span class="lesson-number"></span> Perhaps</button>
      <button class="lesson-btn" onclick="loadLesson(4)"><span class="lesson-number">4</span> –°–∏–Ω–∫–æ–ø—ã</button>
      <button class="lesson-btn" onclick="loadLesson(5)"><span class="lesson-number">5</span> –¢—Ä–∏–æ–ª–∏</button>
      <button class="lesson-btn" onclick="loadLesson(6)"><span class="lesson-number">6</span> –°–ª–æ–∂–Ω—ã–µ —Ä–∏—Ç–º—ã</button>
      <button class="lesson-btn" onclick="loadLesson(7)"><span class="lesson-number">7</span> –ü–æ–ª–∏—Ä–∏—Ç–º–∏—è</button>
      <button class="lesson-btn" onclick="loadLesson(8)"><span class="lesson-number">8</span> –î–∂–∞–∑</button>
      <button class="lesson-btn" onclick="loadLesson(9)"><span class="lesson-number">9</span> –õ–∞—Ç–∏–Ω–∞</button>
      <button class="lesson-btn" onclick="loadLesson(10)"><span class="lesson-number">10</span> –†–æ–∫</button>
      <button class="lesson-btn" onclick="loadLesson(11)"><span class="lesson-number">11</span> –ú–∏—Ä–æ–≤—ã–µ</button>
      <button class="lesson-btn" onclick="loadLesson(12)"><span class="lesson-number">12</span> –ü—Ä–æ—Ñ–∏</button>
      <button class="lesson-btn locked" onclick="showLockedMessage(13)"><span class="lesson-number">13</span> AI-–∞–Ω–∞–ª–∏–∑</button>
      <button class="lesson-btn locked" onclick="showLockedMessage(14)"><span class="lesson-number">14</span> –ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è</button>
      <button class="lesson-btn locked" onclick="showLockedMessage(15)"><span class="lesson-number">15</span> –ö–æ–º–ø–æ–∑–∏—Ü–∏—è</button>
      <button class="lesson-btn locked" onclick="showLockedMessage(16)"><span class="lesson-number">16</span> –ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</button>
    </div>

    <div class="content-section">
      <div class="lesson-content" id="lessonContent">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–≠—Ç–æ—Ç —É—á–µ–±–Ω–∏–∫ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –æ—Å–≤–æ–∏—Ç—å —Ä–∏—Ç–º ‚Äî –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –¥–æ–ª–µ–π –¥–æ —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–∏—Ä–∏—Ç–º–∏–π.</p>
        <div class="tip"><strong>–°–æ–≤–µ—Ç:</strong> –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å —Å –º–µ—Ç—Ä–æ–Ω–æ–º–æ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –¥–∞–∂–µ –ø–æ 10 –º–∏–Ω—É—Ç!</div>
      </div>
      <div class="tools-panel">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <div class="tip"><strong>–ú–µ—Ç—Ä–æ–Ω–æ–º</strong> ‚Äî –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏</div>
        <div class="info-box"><strong>–°–µ–∫–≤–µ–Ω—Å–æ—Ä</strong> ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è</div>
      </div>
    </div>

    <div id="scoresContainer" class="scores-container"></div>

    <div class="exercise-section" id="exerciseSection" style="display:none;">
      <h3>üéØ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
      <div class="rhythm-pattern" id="exercisePattern"></div>
      <div id="exerciseButtons"></div>
      <div class="feedback" id="exerciseFeedback"></div>
      <button class="interactive-btn" onclick="nextExercise()">–°–ª–µ–¥—É—é—â–µ–µ</button>
    </div>

    <div class="quiz-section" id="quizSection" style="display:none;">
      <h3>üß† –¢–µ—Å—Ç</h3>
      <div class="quiz-question" id="quizQuestion"></div>
      <div class="quiz-options" id="quizOptions"></div>
      <button class="interactive-btn" onclick="checkQuizAnswer()" id="quizSubmit" disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <div class="feedback" id="quizFeedback"></div>
    </div>
  </div>

  <script>
  // === –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ===
let osmdInstances = [];
let currentLesson = 0;
let currentQuiz = null;
let selectedQuizAnswer = null;
let audioContext = null;
let sequencers = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–æ–≤

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
async function loadAudioFiles() {
  const sounds = {};
  const soundFiles = {
    kick: 'sounds/kick.wav',
    snare: 'sounds/snare.wav',
    tom1: 'sounds/tom1.wav',
    tom3: 'sounds/tom3.wav',
    crash: 'sounds/crash.wav',
    hihat: 'sounds/hihat.wav'
  };
  
  for (const [name, url] of Object.entries(soundFiles)) {
    try {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      sounds[name] = await audioContext.decodeAudioData(arrayBuffer);
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–≤—É–∫–∞ ${name}:`, error);
    }
  }
  
  return sounds;
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞
function playSound(buffer, time = 0) {
  if (!buffer || !audioContext) return;
  
  const source = audioContext.createBufferSource();
  source.buffer = buffer;
  source.connect(audioContext.destination);
  source.start(time);
}

// === –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞ ===
async function loadLesson(lessonNumber) {
  if (lessonNumber > 12) return showLockedMessage(lessonNumber);
  
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showLoadingState();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –∏–∑ JSON —Ñ–∞–π–ª–∞
    const response = await fetch(`lessons/lesson${lessonNumber}/data.json`);
    if (!response.ok) {
      throw new Error(`–£—Ä–æ–∫ ${lessonNumber} –Ω–µ –Ω–∞–π–¥–µ–Ω (—Å—Ç–∞—Ç—É—Å: ${response.status})`);
    }
    
    const lesson = await response.json();
    currentLesson = lessonNumber;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—Ä–æ–∫–∞
    updateLessonButtons();
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É—Ä–æ–∫–∞
    displayLessonContent(lesson);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–∞—Ä—Ç–∏—Ç—É—Ä—ã
    if (lesson.scores && lesson.scores.length > 0) {
      await displayMultipleScores(lesson.scores);
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
    displayExercise(lesson.exercise);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ—Å—Ç
    displayQuiz(lesson.quiz);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞:', error);
    handleErrorState(lessonNumber, error);
  }
}

// === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===

function showLoadingState() {
  document.getElementById('lessonContent').innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div>–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞...</div>
    </div>
  `;
  document.getElementById('scoresContainer').innerHTML = '';
  document.getElementById('exerciseSection').style.display = 'none';
  document.getElementById('quizSection').style.display = 'none';
}

function updateLessonButtons() {
  document.querySelectorAll('.lesson-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (event && event.target) {
    event.target.classList.add('active');
  }
}

function displayLessonContent(lesson) {
  document.getElementById('lessonContent').innerHTML = `
    <h2>${lesson.title}</h2>
    ${lesson.content || '<p>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.</p>'}
  `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ —è—á–µ–µ–∫ –∏–∑ 1-16 –≤ 0-15
function convertTargetCells(targetCells) {
  const converted = {};
  for (const track in targetCells) {
    converted[track] = targetCells[track].map(step => step - 1);
  }
  return converted;
}

async function displayMultipleScores(scores) {
  const container = document.getElementById('scoresContainer');
  container.innerHTML = '';
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã OSMD –∏ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä—ã
  osmdInstances = [];
  sequencers = [];
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ
  initAudio();
  const sounds = await loadAudioFiles();
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ç—É—Ä
  scores.forEach((score, index) => {
    const scoreItem = document.createElement('div');
    scoreItem.className = 'score-item';
    
    const title = document.createElement('div');
    title.className = 'score-title';
    title.textContent = score.title || `–ü–∞—Ä—Ç–∏—Ç—É—Ä–∞ ${index + 1}`;
    scoreItem.appendChild(title);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if (score.description) {
      const description = document.createElement('div');
      description.className = 'score-description';
      description.textContent = score.description;
      scoreItem.appendChild(description);
    }
    
    const scoreContainer = document.createElement('div');
    scoreContainer.className = 'score-container';
    scoreContainer.id = `scoreContainer${index}`;
    scoreItem.appendChild(scoreContainer);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'score-loading';
    loadingIndicator.innerHTML = '<div style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ç...</div>';
    scoreContainer.appendChild(loadingIndicator);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫–≤–µ–Ω—Å–æ—Ä, –µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á–µ–Ω –≤ JSON
    if (score.sequencer !== false) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ –¥–æ—Ä–æ–∂–∫–∏
      let visibleTracks = ['hihat', 'snare', 'kick']; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ
      let targetCells = {}; // –¶–µ–ª–µ–≤—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      
      if (typeof score.sequencer === 'object') {
        if (Array.isArray(score.sequencer.tracks)) {
          visibleTracks = score.sequencer.tracks;
        }
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–ª–µ–≤—ã—Ö —è—á–µ–π–∫–∞—Ö –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ 1-16 –≤ 0-15
        if (score.sequencer.targetCells) {
          targetCells = convertTargetCells(score.sequencer.targetCells);
        }
      }

      const sequencer = createSequencer(index, sounds, visibleTracks, targetCells);
      scoreItem.appendChild(sequencer);
    }
    
    container.appendChild(scoreItem);
  });
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–∞—Ä—Ç–∏—Ç—É—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  const loadPromises = scores.map(async (score, index) => {
    try {
      const scoreContainer = document.getElementById(`scoreContainer${index}`);
      scoreContainer.innerHTML = ''; // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      
      const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(scoreContainer.id, {    
        autoResize: true,    
        backend: "svg",    
        disableCursor: false,    
        drawingParameters: "default",    
        newSystemFromXML: true,    
        renderSingleHorizontalStaffline: false,     
        drawPartNames: false,    
        drawTitle: false,    
        drawComposer: false,    
        drawFingerings: true,    
        autoBeam: false,    
        pageFormat: "Endless"
         
      });    
      
      await osmd.load(score.url);  
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–û–°–õ–ï load(), –Ω–æ –ü–ï–†–ï–î render()  
      osmd.EngravingRules.RenderXMeasuresPerLineAkaSystem = 4;    
      osmd.EngravingRules.PageTopMargin = 5;    
      osmd.EngravingRules.PageBottomMargin = 1;    
      osmd.EngravingRules.PageLeftMargin = 5;    
      osmd.EngravingRules.PageRightMargin = 5;    
      osmd.EngravingRules.BetweenStaffDistance = 7;    
      osmd.EngravingRules.StaffHeight = 3.2;    
      
      await osmd.render();    
      
      osmd.zoom = 0.95;    
      osmdInstances.push(osmd);
      
    } catch (err) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏—Ç—É—Ä—ã ${score.title || index + 1}:`, err);
      const scoreContainer = document.getElementById(`scoreContainer${index}`);
      if (scoreContainer) {
        scoreContainer.innerHTML = `
          <div class="score-error">
            <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏—Ç—É—Ä—ã</div>
            <div style="font-size: 0.9em; margin-top: 5px;">${score.url}</div>
          </div>
        `;
      }
    }
  });
  
  // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∑–æ–∫
  await Promise.all(loadPromises);
  
  // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –¥–ª—è —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  setTimeout(() => {
    scores.forEach((score, index) => {
      if (score.sequencer !== false) {
        createSequencerCells(index);
      }
    });
  }, 0);
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
function createSequencer(scoreIndex, sounds, visibleTracks = ['crash', 'hihat', 'snare', 'tom1', 'tom3', 'kick'], targetCells = {}) {
  const sequencerDiv = document.createElement('div');
  sequencerDiv.className = 'sequencer';
  sequencerDiv.id = `sequencer-${scoreIndex}`;
  
  sequencerDiv.innerHTML = `
    <div class="drum-grid" id="drumGrid-${scoreIndex}"></div>
    
    <div class="sequencer-controls">
      <button class="sequencer-btn play" id="playButton-${scoreIndex}" onclick="playSequencer(${scoreIndex})">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
      <button class="sequencer-btn stop" id="stopButton-${scoreIndex}" onclick="stopSequencer(${scoreIndex})" disabled>‚èπÔ∏è –°—Ç–æ–ø</button>
      <button class="sequencer-btn" onclick="clearSequencer(${scoreIndex})">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div class="tempo-control">
      <span class="tempo-label">–¢–µ–º–ø:</span>
      <input type="range" id="sequencer-tempo-${scoreIndex}" min="40" max="240" value="120" />
      <span id="tempo-value-${scoreIndex}">120 BPM</span>
    </div>
  `;
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö –¥–æ—Ä–æ–∂–µ–∫
  const initialTracks = {};
  visibleTracks.forEach(track => {
    initialTracks[track] = Array(16).fill(0);
  });

  sequencers[scoreIndex] = {
    tracks: initialTracks,
    visibleTracks: visibleTracks,
    targetCells: targetCells, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª–µ–≤—ã–µ —è—á–µ–π–∫–∏ (—É–∂–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
    isPlaying: false,
    currentStep: 0,
    intervalId: null,
    sounds: sounds,
    bpm: 120
  };
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º–ø–∞
  setTimeout(() => {
    const tempoSlider = document.getElementById(`sequencer-tempo-${scoreIndex}`);
    const tempoValue = document.getElementById(`tempo-value-${scoreIndex}`);
    
    if (tempoSlider && tempoValue) {
      tempoSlider.addEventListener('input', function() {
        sequencers[scoreIndex].bpm = parseInt(this.value);
        tempoValue.textContent = `${this.value} BPM`;
        // –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º —Ç–µ–º–ø–æ–º
        if (sequencers[scoreIndex].isPlaying) {
          stopSequencer(scoreIndex);
          playSequencer(scoreIndex);
        }
      });
    }
  }, 0);
  
  return sequencerDiv;
}

// –°–æ–∑–¥–∞–Ω–∏–µ —è—á–µ–µ–∫ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
function createSequencerCells(scoreIndex) {
  const grid = document.getElementById(`drumGrid-${scoreIndex}`);
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const sequencer = sequencers[scoreIndex];
  const tracks = sequencer.visibleTracks;
  const trackNames = {
    'hihat': 'HiHat',
    'crash': 'Crash',
    'snare': 'Snare',
    'tom1': 'Tom1',
    'tom3': 'Tom3',
    'kick': 'Kick'
  };
  
  tracks.forEach(trackName => {
    const row = document.createElement('div');
    row.className = 'track-row';
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'track-name';
    nameDiv.textContent = trackNames[trackName];
    row.appendChild(nameDiv);
    
    const stepsDiv = document.createElement('div');
    stepsDiv.className = 'track-steps';
    
    for (let i = 0; i < 16; i++) {
      const stepDiv = document.createElement('div');
      stepDiv.className = `step ${sequencer.tracks[trackName][i] ? 'active' : ''}`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø –ø–æ 4
      const groupIndex = Math.floor(i / 4);
      stepDiv.classList.add(`group-${groupIndex % 4}`);
      
      stepDiv.dataset.track = trackName;
      stepDiv.dataset.step = i;
      stepDiv.dataset.score = scoreIndex;
      stepDiv.textContent = sequencer.tracks[trackName][i] ? '‚óè' : '';
      
      stepDiv.addEventListener('click', function() {
        toggleSequencerStep(this);
      });
      
      stepsDiv.appendChild(stepDiv);
    }
    
    row.appendChild(stepsDiv);
    grid.appendChild(row);
  });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —è—á–µ–π–∫–∏
function toggleSequencerStep(cell) {
  const track = cell.dataset.track;
  const step = parseInt(cell.dataset.step);
  const scoreIndex = parseInt(cell.dataset.score);
  
  const sequencer = sequencers[scoreIndex];
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö (0 –∏–ª–∏ 1)
  sequencer.tracks[track][step] = sequencer.tracks[track][step] ? 0 : 1;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (sequencer.tracks[track][step]) {
    cell.classList.add('active');
    cell.textContent = '‚óè';
  } else {
    cell.classList.remove('active');
    cell.textContent = '';
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  checkSequencerHighlight(scoreIndex);
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
function checkSequencerHighlight(scoreIndex) {
  const sequencer = sequencers[scoreIndex];
  const targetCells = sequencer.targetCells;
  const sequencerDiv = document.getElementById(`sequencer-${scoreIndex}`);
  
  // –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö —è—á–µ–µ–∫, —É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
  if (!targetCells || Object.keys(targetCells).length === 0) {
    sequencerDiv.classList.remove('highlighted');
    return;
  }
  
  let allMatch = true;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –¥–æ—Ä–æ–∂–∫—É
  for (const trackName in targetCells) {
    const targetSteps = targetCells[trackName];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É
    for (const step of targetSteps) {
      // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–∞—è —è—á–µ–π–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, —É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
      if (!sequencer.tracks[trackName] || !sequencer.tracks[trackName][step]) {
        allMatch = false;
        break;
      }
    }
    
    if (!allMatch) break;
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —è—á–µ–µ–∫
  if (allMatch) {
    for (const trackName in sequencer.tracks) {
      for (let i = 0; i < sequencer.tracks[trackName].length; i++) {
        // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ü–µ–ª–µ–≤—ã–µ
        if (sequencer.tracks[trackName][i] === 1) {
          const isTarget = targetCells[trackName] && targetCells[trackName].includes(i);
          if (!isTarget) {
            allMatch = false;
            break;
          }
        }
      }
      if (!allMatch) break;
    }
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
  if (allMatch && Object.keys(targetCells).length > 0) {
    sequencerDiv.classList.add('highlighted');
  } else {
    sequencerDiv.classList.remove('highlighted');
  }
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
function playSequencer(scoreIndex) {
  const sequencer = sequencers[scoreIndex];
  if (sequencer.isPlaying || !audioContext) return;
  
  // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º AudioContext –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  
  sequencer.isPlaying = true;
  sequencer.currentStep = 0;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
  const playBtn = document.getElementById(`playButton-${scoreIndex}`);
  const stopBtn = document.getElementById(`stopButton-${scoreIndex}`);
  //if (playBtn) playBtn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
  if (stopBtn) stopBtn.disabled = false;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (16-—Ç–∏ –Ω–æ—Ç–Ω—ã–π —à–∞–≥)
  const stepTime = (60 / sequencer.bpm) / 4 * 1000;
  
  sequencer.intervalId = setInterval(() => {
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
    highlightSequencerStep(scoreIndex, sequencer.currentStep);
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    Object.keys(sequencer.tracks).forEach(trackName => {
      if (sequencer.tracks[trackName][sequencer.currentStep] && sequencer.sounds[trackName]) {
        playSound(sequencer.sounds[trackName]);
      }
    });
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    sequencer.currentStep = (sequencer.currentStep + 1) % 16;
  }, stepTime);
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
function stopSequencer(scoreIndex) {
  const sequencer = sequencers[scoreIndex];
  if (!sequencer.isPlaying) return;
  
  clearInterval(sequencer.intervalId);
  sequencer.isPlaying = false;
  sequencer.currentStep = 0;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
  const playBtn = document.getElementById(`playButton-${scoreIndex}`);
  const stopBtn = document.getElementById(`stopButton-${scoreIndex}`);
  if (playBtn) playBtn.textContent = '‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å';
  if (stopBtn) stopBtn.disabled = true;
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
  clearSequencerHighlights(scoreIndex);
}

// –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
function highlightSequencerStep(scoreIndex, step) {
  clearSequencerHighlights(scoreIndex);
  
  const cells = document.querySelectorAll(`#sequencer-${scoreIndex} .step[data-step="${step}"]`);
  cells.forEach(cell => cell.classList.add('playing'));
}

// –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è —à–∞–≥–æ–≤
function clearSequencerHighlights(scoreIndex) {
  const cells = document.querySelectorAll(`#sequencer-${scoreIndex} .step.playing`);
  cells.forEach(cell => cell.classList.remove('playing'));
}

// –û—á–∏—Å—Ç–∫–∞ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
function clearSequencer(scoreIndex) {
  const sequencer = sequencers[scoreIndex];
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
  if (sequencer.isPlaying) {
    stopSequencer(scoreIndex);
  }
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  Object.keys(sequencer.tracks).forEach(trackName => {
    sequencer.tracks[trackName] = Array(16).fill(0);
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  createSequencerCells(scoreIndex);
  
  // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
  const sequencerDiv = document.getElementById(`sequencer-${scoreIndex}`);
  sequencerDiv.classList.remove('highlighted');
}

function displayExercise(exercise) {
  if (exercise) {
    document.getElementById('exerciseSection').style.display = 'block';
    document.getElementById('exercisePattern').textContent = exercise.pattern;
    const btns = document.getElementById('exerciseButtons');
    btns.innerHTML = '';
    exercise.buttons.forEach((lbl, i) => {
      const b = document.createElement('button');
      b.className = 'interactive-btn';
      b.textContent = lbl;
      b.onclick = () => checkExercise(i, exercise.correct[i]);
      btns.appendChild(b);
    });
    document.getElementById('exerciseFeedback').textContent = '';
  } else {
    document.getElementById('exerciseSection').style.display = 'none';
  }
}

function displayQuiz(quiz) {
  if (quiz) {
    document.getElementById('quizSection').style.display = 'block';
    loadQuiz(quiz);
  } else {
    document.getElementById('quizSection').style.display = 'none';
  }
}

function handleErrorState(lessonNumber, error) {
  document.getElementById('lessonContent').innerHTML = `
    <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞ ${lessonNumber}</h2>
    <div class="warning">
      <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
    </div>
    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:</p>
    <ul>
      <li>–°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª <code>lessons/lesson${lessonNumber}/data.json</code></li>
      <li>–ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON</li>
      <li>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤ –ø–∞—Ä—Ç–∏—Ç—É—Ä</li>
    </ul>
  `;
  document.getElementById('scoresContainer').innerHTML = '';
  document.getElementById('exerciseSection').style.display = 'none';
  document.getElementById('quizSection').style.display = 'none';
}

// === –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===

function loadQuiz(q) {
  currentQuiz = q;
  selectedQuizAnswer = null;
  document.getElementById('quizQuestion').textContent = q.question;
  const c = document.getElementById('quizOptions');
  c.innerHTML = '';
  q.options.forEach((opt, i) => {
    const b = document.createElement('button');
    b.className = 'quiz-btn';
    b.textContent = opt;
    b.onclick = () => {
      document.querySelectorAll('.quiz-btn').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
      selectedQuizAnswer = i;
      document.getElementById('quizSubmit').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('quizSubmit').disabled = true;
  document.getElementById('quizFeedback').textContent = '';
}

function checkQuizAnswer() {
  if (selectedQuizAnswer === null) return;
  const btns = document.querySelectorAll('.quiz-btn');
  const fb = document.getElementById('quizFeedback');
  if (selectedQuizAnswer === currentQuiz.correct) {
    btns[selectedQuizAnswer].classList.add('correct');
    fb.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
    fb.style.color = 'var(--success)';
  } else {
    btns[selectedQuizAnswer].classList.add('wrong');
    btns[currentQuiz.correct].classList.add('correct');
    fb.textContent = '–ù–µ–≤–µ—Ä–Ω–æ. –°–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.';
    fb.style.color = 'var(--danger)';
  }
  document.getElementById('quizSubmit').disabled = true;
}

function checkExercise(i, v) {
  const btns = document.querySelectorAll('.interactive-btn');
  const fb = document.getElementById('exerciseFeedback');
  const ok = Math.random() > 0.4;
  if (ok) {
    btns[i].classList.add('correct');
    fb.textContent = '–û—Ç–ª–∏—á–Ω–æ!';
    fb.style.color = 'var(--success)';
  } else {
    btns[i].classList.add('wrong');
    fb.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë.';
    fb.style.color = 'var(--danger)';
  }
}

function nextExercise() {
  document.getElementById('exerciseFeedback').textContent = '–°–ª–µ–¥—É—é—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...';
  setTimeout(() => {
    document.getElementById('exerciseFeedback').textContent = '';
    document.querySelectorAll('.interactive-btn').forEach(b => b.classList.remove('correct', 'wrong'));
  }, 1000);
}

function showLockedMessage(n) {
  alert(`üîí –£—Ä–æ–∫ ${n} –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`);
}
  </script>
</body>
</html>
