<!DOCTYPE html>
<html>
<head>
    <title>–ò–∑—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ—Ç</title>
    <style>
        /* –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
        }
        
        canvas { 
            border: 2px solid #333; 
            background-color: white;
            margin: 20px auto;
            display: block;
        }
        
        button { 
            padding: 15px 25px; 
            margin: 10px;
            font-size: 18px; 
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #message {
            font-size: 20px;
            min-height: 30px;
            margin: 15px;
        }
        
        .correct { color: green; font-weight: bold; }
        .incorrect { color: red; font-weight: bold; }
        
        h1 {
            color: #333;
        }
        
        #controls {
            margin: 20px;
        }
        
        #note-selector {
            margin: 20px;
        }
        
        .note-group {
            display: inline-block;
            margin: 8px;
            padding: 10px 12px;
            border: 2px solid #333;
            border-radius: 5px;
            background-color: #e0e0e0;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
        }
        
        .note-group:hover {
            background-color: #d0d0d0;
        }
        
        .note-group.selected {
            background-color: #2196F3;
            color: white;
        }
        
        #selector-controls {
            margin: 10px;
        }
        
        #selector-controls button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
        }
        
        /* –°—Ç–∏–ª–∏ –∏–∑ drum-library.css */
        .drum-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .drum-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .control-group input, 
        .control-group button, 
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .drum-grid {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .track-row {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .track-row:last-child {
            border-bottom: none;
        }

        .track-name {
            width: 120px;
            padding: 15px;
            font-weight: bold;
            background: #f8f9fa;
            text-align: right;
            border-right: 1px solid #eee;
        }

        .track-steps {
            display: flex;
            flex: 1;
            padding: 5px;
        }

        .step {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            margin: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ 4 —è—á–µ–π–∫–∏ */
        .step.group-0 {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .step.group-0.active {
            background-color: #ffc107;
            border-color: #e0a800;
        }

        .step.group-1 {
            background-color: #d1ecf1;
            border-color: #b8daff;
        }

        .step.group-1.active {
            background-color: #17a2b8;
            border-color: #138496;
        }

        .step.group-2 {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .step.group-2.active {
            background-color: #dc3545;
            border-color: #bd2130;
        }

        .step.group-3 {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .step.group-3.active {
            background-color: #28a745;
            border-color: #1e7e34;
        }

        .step:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .step.active {
            background-color: #007bff;
            border-color: #0056b3;
            color: white;
            font-weight: bold;
        }

        .step.playing {
            background-color: #ff6b6b !important;
            border-color: #ff5252 !important;
            transform: scale(1.1);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .drum-container {
                padding: 10px;
            }
            
            .track-name {
                width: 80px;
                padding: 10px;
                font-size: 12px;
            }
            
            .step {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <h1>üéµ –ò–∑—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ—Ç üéµ</h1>
    
    <div id="note-selector">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –Ω–æ—Ç:</h3>
        <div class="note-group" onclick="toggleNoteType('quarter')">–ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è</div>
        <div class="note-group" onclick="toggleNoteType('eighth_pair')">–í–æ—Å—å–º—ã–µ</div>
        <div class="note-group" onclick="toggleNoteType('sixteenth_quartet')">–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã–µ</div>
        <div class="note-group" onclick="toggleNoteType('sixteenth_pair_eighth')">2 —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö + –≤–æ—Å—å–º–∞—è</div>
        <div class="note-group" onclick="toggleNoteType('eighth_sixteenth_pair')">–í–æ—Å—å–º–∞—è + –¥–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö</div>
        <div class="note-group" onclick="toggleNoteType('sixteenth_eighth_sixteenth')">–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è + –≤–æ—Å—å–º–∞—è + —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è</div>
    </div>
    
    <div id="controls">
        <button onclick="newQuestion()">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä</button>
    </div>
    
    <canvas id="gameCanvas" width="800" height="300"></canvas>

    <div style="padding: 20px;">
        <div class="drum-container">
            <div class="drum-grid" id="drumGrid"></div>
            <div class="drum-controls">
                <div class="control-group">
                    <button onclick="playPattern()" id="playButton">–ü—Ä–æ–∏–≥—Ä–∞—Ç—å</button>
                    <button onclick="clearPattern()" id="clearButton">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <input type="range" id="bpm" min="40" max="240" value="60">
                    <span>BPM: <span id="bpmValue">60</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="message"></div>
    
    <script>
        /* --------------------------------------------------------------
           –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π JavaScript
           --------------------------------------------------------------*/

        /* ------------------------------------------------------------------------
           Game Logic
           ------------------------------------------------------------------------*/
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const messageDiv = document.getElementById('message');

        const noteDurations = {
            "quarter": {name: "–ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è", beats: 1},
            "eighth_pair": {name: "–í–æ—Å—å–º—ã–µ", beats: 1},
            "sixteenth_quartet": {name: "–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã–µ", beats: 1},
            "sixteenth_pair_eighth": {name: "–î–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö + –≤–æ—Å—å–º–∞—è", beats: 2},
            "eighth_sixteenth_pair": {name: "–í–æ—Å—å–º–∞—è + –¥–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö", beats: 2},
            "sixteenth_eighth_sixteenth": {name: "–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è + –≤–æ—Å—å–º–∞—è + —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è", beats: 2}
        };

        let currentNotes = [];
        let selectedNoteTypes = new Set([
            'quarter', 
            'eighth_pair', 
            'sixteenth_quartet', 
            'sixteenth_pair_eighth',
            'eighth_sixteenth_pair',
            'sixteenth_eighth_sixteenth'
        ]);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞/–æ—Ç–º–µ–Ω—ã –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –Ω–æ—Ç
        function toggleNoteType(noteType) {
            const noteNames = {
                "quarter": "–ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è",
                "eighth_pair": "–í–æ—Å—å–º—ã–µ",
                "sixteenth_quartet": "–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã–µ",
                "sixteenth_pair_eighth": "2 —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö + –≤–æ—Å—å–º–∞—è",
                "eighth_sixteenth_pair": "–í–æ—Å—å–º–∞—è + –¥–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö",
                "sixteenth_eighth_sixteenth": "–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è + –≤–æ—Å—å–º–∞—è + —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è"
            };
            
            const elements = document.querySelectorAll('.note-group');
            elements.forEach(element => {
                if (element.textContent.includes(noteNames[noteType])) {
                    if (selectedNoteTypes.has(noteType)) {
                        selectedNoteTypes.delete(noteType);
                        element.classList.remove('selected');
                    } else {
                        selectedNoteTypes.add(noteType);
                        element.classList.add('selected');
                    }
                }
            });
        }

        // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –Ω–æ—Ç
        function selectAll() {
            selectedNoteTypes = new Set([
                'quarter', 
                'eighth_pair', 
                'sixteenth_quartet', 
                'sixteenth_pair_eighth',
                'eighth_sixteenth_pair',
                'sixteenth_eighth_sixteenth'
            ]);
            const elements = document.querySelectorAll('.note-group');
            elements.forEach(element => element.classList.add('selected'));
        }

        // –°–Ω—è—Ç—å –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Ç
        function deselectAll() {
            selectedNoteTypes.clear();
            const elements = document.querySelectorAll('.note-group');
            elements.forEach(element => element.classList.remove('selected'));
        }

        // –ö–ª–∞—Å—Å –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–æ—Ç
        class MusicNotes {
            constructor(ctx) {
                this.ctx = ctx;
                this.ovalWidth = 16;
                this.ovalHeight = 10;
                this.stemHeight = 55;
                this.lineY = 190;
            }
            
            clear() {
                this.ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.drawStaff();
            }
            
            drawStaff() {
                const y = 150;
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(50, y + i * 20);
                    this.ctx.lineTo(750, y + i * 20);
                    this.ctx.stroke();
                }
            }
            
            // –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è –Ω–æ—Ç–∞
            drawQuarterNote(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const stemX = x + this.ovalWidth;
                
                this.ctx.beginPath();
                this.ctx.moveTo(stemX, this.lineY - 5);
                this.ctx.lineTo(stemX, stemTopY);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.ellipse(x, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                this.ctx.fillStyle = color;
                this.ctx.fill();
            }
            
            // –ü–∞—Ä–∞ –≤–æ—Å—å–º—ã—Ö –Ω–æ—Ç
            drawEighthPair(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const stemX1 = x - 8 + this.ovalWidth;
                const stemX2 = x + 48 + this.ovalWidth;
                const beamY = stemTopY + 5;
                
                this.ctx.beginPath();
                this.ctx.moveTo(stemX1, this.lineY - 5);
                this.ctx.lineTo(stemX1, beamY);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.ellipse(x - 8, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                this.ctx.fillStyle = color;
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.moveTo(stemX2, this.lineY - 5);
                this.ctx.lineTo(stemX2, beamY);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.ellipse(x + 48, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                this.ctx.fillStyle = color;
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.moveTo(stemX1, beamY);
                this.ctx.lineTo(stemX2, beamY);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
            }
            
            // –ß–µ—Ç–≤–µ—Ä–∫–∞ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö –Ω–æ—Ç
            drawSixteenthQuartet(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const beamY1 = stemTopY + 5;
                const beamY2 = stemTopY + 20;
                const ovalPositions = [-8, 24, 56, 88];
                const stemPositions = ovalPositions.map(pos => pos + this.ovalWidth);
                
                for (let i = 0; i < 4; i++) {
                    const ovalX = x + ovalPositions[i];
                    const stemX = x + stemPositions[i];
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, this.lineY - 5);
                    this.ctx.lineTo(stemX, stemTopY);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.ellipse(ovalX, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                    this.ctx.fillStyle = color;
                    this.ctx.fill();
                }
                
                this.ctx.beginPath();
                this.ctx.moveTo(x + stemPositions[0], beamY1);
                this.ctx.lineTo(x + stemPositions[3], beamY1);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(x + stemPositions[0], beamY2);
                this.ctx.lineTo(x + stemPositions[3], beamY2);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                for (let i = 0; i < 4; i++) {
                    const stemX = x + stemPositions[i];
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, beamY1);
                    this.ctx.lineTo(stemX, beamY2);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                }
            }
            
            // –î–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö + –æ–¥–Ω–∞ –≤–æ—Å—å–º–∞—è
            drawSixteenthPairEighth(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const beamY1 = stemTopY + 5;
                const beamY2 = stemTopY + 20;
                const eighthBeamY = stemTopY + 5;
                
                const ovalPositions = [0, 32, 80];
                const stemPositions = ovalPositions.map(pos => pos + this.ovalWidth);
                
                for (let i = 0; i < 3; i++) {
                    const ovalX = x + ovalPositions[i];
                    const stemX = x + stemPositions[i];
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, this.lineY - 5);
                    this.ctx.lineTo(stemX, stemTopY);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.ellipse(ovalX, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                    this.ctx.fillStyle = color;
                    this.ctx.fill();
                }
                
                const firstStemX = x + stemPositions[0];
                const secondStemX = x + stemPositions[1];
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY1);
                this.ctx.lineTo(secondStemX, beamY1);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY2);
                this.ctx.lineTo(secondStemX, beamY2);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                for (let i = 0; i < 2; i++) {
                    const stemX = x + stemPositions[i];
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, beamY1);
                    this.ctx.lineTo(stemX, beamY2);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                }
                
                const thirdStemX = x + stemPositions[2];
                this.ctx.beginPath();
                this.ctx.moveTo(thirdStemX, eighthBeamY);
                this.ctx.lineTo(secondStemX, eighthBeamY);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
            }
            
            // –í–æ—Å—å–º–∞—è + –¥–≤–µ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã—Ö
            drawEighthSixteenthPair(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const beamY1 = stemTopY + 5;
                const beamY2 = stemTopY + 20;
                
                const positions = [32, 64, 96];
                const ovalPositions = [16, 48, 80];
                const stemPositions = positions;
                
                for (let i = 0; i < 3; i++) {
                    const ovalX = x + ovalPositions[i];
                    const stemX = x + stemPositions[i];
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, this.lineY - 5);
                    this.ctx.lineTo(stemX, stemTopY);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.ellipse(ovalX, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                    this.ctx.fillStyle = color;
                    this.ctx.fill();
                }
                
                const firstStemX = x + stemPositions[0];
                const secondStemX = x + stemPositions[1];
                const thirdStemX = x + stemPositions[2];
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY1);
                this.ctx.lineTo(thirdStemX, beamY1);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(secondStemX, beamY2);
                this.ctx.lineTo(thirdStemX, beamY2);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY1);
                this.ctx.lineTo(firstStemX, beamY2 - 15);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(secondStemX, beamY1);
                this.ctx.lineTo(secondStemX, beamY2);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(thirdStemX, beamY1);
                this.ctx.lineTo(thirdStemX, beamY2);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
            }
            
            // –®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è + –≤–æ—Å—å–º–∞—è + —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è
            drawSixteenthEighthSixteenth(x, y, color = 'black') {
                const stemTopY = this.lineY - this.stemHeight;
                const beamY1 = stemTopY + 5;
                const beamY2 = stemTopY + 20;
                
                const positions = [16, 48, 96];
                const ovalPositions = [0, 32, 80];
                const stemPositions = positions;
                
                for (let i = 0; i < 3; i++) {
                    const ovalX = x + ovalPositions[i];
                    const stemX = x + stemPositions[i];
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(stemX, this.lineY - 5);
                    this.ctx.lineTo(stemX, stemTopY);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = color;
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.ellipse(ovalX, this.lineY, this.ovalWidth, this.ovalHeight, 0, 0, 2 * Math.PI);
                    this.ctx.fillStyle = color;
                    this.ctx.fill();
                }
                
                const firstStemX = x + stemPositions[0];
                const secondStemX = x + stemPositions[1];
                const thirdStemX = x + stemPositions[2];
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY1);
                this.ctx.lineTo(thirdStemX, beamY1);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY2);
                this.ctx.lineTo(firstStemX + 16, beamY2);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(thirdStemX - 16, beamY2);
                this.ctx.lineTo(thirdStemX, beamY2);
                this.ctx.lineWidth = 5;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(firstStemX, beamY1);
                this.ctx.lineTo(firstStemX, beamY2);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(secondStemX, beamY1);
                this.ctx.lineTo(secondStemX, beamY2 - 15);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
                
                this.ctx.beginPath();
                this.ctx.moveTo(thirdStemX, beamY1);
                this.ctx.lineTo(thirdStemX, beamY2);
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = color;
                this.ctx.stroke();
            }
            
            drawNote(noteType, x, y) {
                switch(noteType) {
                    case 'quarter':
                        this.drawQuarterNote(x, y);
                        break;
                    case 'eighth_pair':
                        this.drawEighthPair(x, y);
                        break;
                    case 'sixteenth_quartet':
                        this.drawSixteenthQuartet(x, y);
                        break;
                    case 'sixteenth_pair_eighth':
                        this.drawSixteenthPairEighth(x, y);
                        break;
                    case 'eighth_sixteenth_pair':
                        this.drawEighthSixteenthPair(x, y);
                        break;
                    case 'sixteenth_eighth_sixteenth':
                        this.drawSixteenthEighthSixteenth(x, y);
                        break;
                }
            }
        }

        const notes = new MusicNotes(ctx);

        function newQuestion() {
            currentNotes = [];
            messageDiv.textContent = "";
            messageDiv.className = "";
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã –Ω–æ—Ç
            if (selectedNoteTypes.size === 0) {
                messageDiv.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –Ω–æ—Ç!";
                messageDiv.className = "incorrect";
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 4 —Å–ª—É—á–∞–π–Ω—ã–µ –≥—Ä—É–ø–ø—ã –Ω–æ—Ç –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
            const noteKeys = Array.from(selectedNoteTypes);
            const positions = [120, 280, 440, 600];
            
            for (let i = 0; i < 4; i++) {
                const noteType = noteKeys[Math.floor(Math.random() * noteKeys.length)];
                currentNotes.push({
                    type: noteType,
                    position: positions[i],
                    beats: noteDurations[noteType].beats
                });
            }
            
            drawNotes();
        }

        function drawNotes() {
            notes.clear();
            
            // –†–∏—Å—É–µ–º –≤—Å–µ 4 –≥—Ä—É–ø–ø—ã –Ω–æ—Ç –Ω–∞ —Ç—Ä–µ—Ç—å–µ–π –ª–∏–Ω–∏–∏
            for (let i = 0; i < currentNotes.length; i++) {
                const note = currentNotes[i];
                switch(note.type) {
                    case 'eighth_pair':
                        notes.drawNote(note.type, note.position - 32, 0);
                        break;
                    case 'sixteenth_quartet':
                        notes.drawNote(note.type, note.position - 48, 0);
                        break;
                    case 'sixteenth_pair_eighth':
                        notes.drawNote(note.type, note.position - 40, 0);
                        break;
                    case 'eighth_sixteenth_pair':
                        notes.drawNote(note.type, note.position - 48, 0);
                        break;
                    case 'sixteenth_eighth_sixteenth':
                        notes.drawNote(note.type, note.position - 48, 0);
                        break;
                    default:
                        notes.drawNote(note.type, note.position, 0);
                        break;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
        selectAll();

        /* ------------------------------------------------------------------------
           Drum Sequencer
           ------------------------------------------------------------------------*/
        class DrumSequencer {
            constructor() {
                /* ---------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---------- */
                this.track = 'snare';     // —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç—Ä–µ–∫
                this.steps = 16;          // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ (16‚Äë16‚Äëth –Ω–æ—Ç)
                this.bpm   = 60;         // –Ω–∞—á–∞–ª—å–Ω–æ–µ BPM

                /* ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---------- */
                this.pattern       = new Array(this.steps).fill(0); // –ø—Ä–æ—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
                this.isPlaying     = false;            // —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç?
                this.currentStep   = 0;                // —Ç–µ–∫—É—â–∏–π —à–∞–≥ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                this.intervalId    = null;             // ID setInterval
                this.audioContext  = null;             // Web Audio API context
                this.samples       = {};               // –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ AudioBuffer‚Äë—ã
                this.audioReady    = false;            // true, –∫–æ–≥–¥–∞ –≤—Å–µ —Å—ç–º–ø–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã

                /* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------- */
                this.renderGrid();        // –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞
                this.setupEventListeners();

                // —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–≤—É–∫–æ–≤
                this.initAudio();
            }

            /* ------------------------------------------------------------------------
               AUDIO ‚Äì –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å—ç–º–ø–ª–æ–≤
               ------------------------------------------------------------------------ */
            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext ||
                                           window.webkitAudioContext)();

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ snare
                    const url = 'sounds/snare.wav';
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ snare...');

                    const resp = await fetch(url);
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}`);
                    }
                    const arrayBuf = await resp.arrayBuffer();
                    this.samples.snare = await this.audioContext.decodeAudioData(arrayBuf);
                    console.log('‚úîÔ∏è snare –∑–∞–≥—Ä—É–∂–µ–Ω');
                    
                    this.audioReady = true;
                    console.log('–°—ç–º–ø–ª –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', e);
                }
            }

            playSound(name) {
                if (!this.audioReady) {
                    console.warn('–ó–≤—É–∫ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    return;
                }
                const buffer = this.samples[name];
                if (!buffer) {
                    console.warn(`–°—ç–º–ø–ª "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    return;
                }

                try {
                    const src = this.audioContext.createBufferSource();
                    src.buffer = buffer;
                    src.connect(this.audioContext.destination);
                    src.start(0);
                } catch (e) {
                    console.error(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ${name}:`, e);
                }
            }

            /* ------------------------------------------------------------------------
               GRID ‚Äì —Ä–∞–±–æ—Ç–∞ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
               ------------------------------------------------------------------------ */
            renderGrid() {
                const grid = document.getElementById('drumGrid');
                if (!grid) {
                    console.error('#drumGrid —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
                    return;
                }
                grid.innerHTML = '';

                const row = document.createElement('div');
                row.className = 'track-row';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'track-name';
                nameDiv.textContent = this.track;
                row.appendChild(nameDiv);

                const stepsDiv = document.createElement('div');
                stepsDiv.className = 'track-steps';

                this.pattern.forEach((v, i) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = `step ${v ? 'active' : ''}`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø –ø–æ 4
                    const groupIndex = Math.floor(i / 4);
                    stepDiv.classList.add(`group-${groupIndex % 4}`);
                    
                    stepDiv.dataset.step = i;
                    stepDiv.textContent = v ? '‚óè' : '';
                    stepDiv.addEventListener('click', () => this.toggleStep(i));
                    stepsDiv.appendChild(stepDiv);
                });

                row.appendChild(stepsDiv);
                grid.appendChild(row);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –º–µ—Ç–æ–¥
            toggleStep(step) {
                this.pattern[step] = this.pattern[step] ? 0 : 1;
                this.renderGrid();
            }

            /* ------------------------------------------------------------------------
               PLAYBACK ‚Äì –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
               ------------------------------------------------------------------------ */
            playPattern() {
                if (this.isPlaying) {
                    this.stopPattern();
                    return;
                }

                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—ã–ª ¬´–∑–∞–º–æ—Ä–æ–∂–µ–Ω¬ª, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                if (!this.audioReady) {
                    alert('–ó–≤—É–∫ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.');
                    return;
                }

                this.isPlaying = true;
                document.getElementById('playButton').textContent = '–°—Ç–æ–ø';

                const stepTime = (60 / this.bpm) / 4 * 1000; // 16‚Äë—Ç–∏ –Ω–æ—Ç–Ω—ã–π —à–∞–≥

                this.intervalId = setInterval(() => {
                    this.highlightStep(this.currentStep);

                    // –ò–≥—Ä–∞–µ–º snare –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
                    if (this.pattern[this.currentStep]) {
                        this.playSound(this.track);
                    }

                    this.currentStep = (this.currentStep + 1) % this.steps;
                }, stepTime);
            }

            stopPattern() {
                this.isPlaying = false;
                clearInterval(this.intervalId);
                document.getElementById('playButton').textContent = '–ü—Ä–æ–∏–≥—Ä–∞—Ç—å';
                this.clearHighlights();
                this.currentStep = 0;
            }

            highlightStep(step) {
                this.clearHighlights();
                const cell = document.querySelector(`.step[data-step="${step}"]`);
                if (cell) cell.classList.add('playing');
            }

            clearHighlights() {
                const cells = document.querySelectorAll('.step.playing');
                cells.forEach(c => c.classList.remove('playing'));
            }

            clearPattern() {
                this.pattern = new Array(this.steps).fill(0);
                this.renderGrid();
                this.stopPattern();
            }

            /* ------------------------------------------------------------------------
               UI ‚Äì –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
               ------------------------------------------------------------------------ */
            setBPM(val) {
                this.bpm = val;
                if (this.isPlaying) {
                    this.stopPattern();
                    this.playPattern();
                }
            }

            setupEventListeners() {
                // BPM‚Äë—Å–ª–∞–π–¥–µ—Ä
                const bpmSlider = document.getElementById('bpm');
                const bpmVal = document.getElementById('bpmValue');
                if (bpmSlider && bpmVal) {
                    bpmSlider.addEventListener('input', () => {
                        this.setBPM(parseInt(bpmSlider.value, 10));
                        bpmVal.textContent = this.bpm;
                    });
                }
            }
        }

        /* ------------------------------------------------------------------------
           –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
           ------------------------------------------------------------------------ */
        document.addEventListener('DOMContentLoaded', () => {
            window.drumSequencer = new DrumSequencer();

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
            window.playPattern = () => drumSequencer.playPattern();
            window.clearPattern = () => drumSequencer.clearPattern();
        });
    </script>
</body>
</html>
